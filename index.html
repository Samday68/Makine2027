<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>VOLATILITY ANALYZER V.1.0</title>
  <link rel="manifest" href="manifest.json">
  <style>
    /* ... Diğer CSS kodları değişmeden aynı kaldı ... */
    
    /* GÜNCELLENMİŞ: Trend Açı Panelleri Container - YAN YANA */
    #trendAnglesRow { 
      display: flex; 
      flex-direction: row;
      gap: 4px; 
      width: 100%; 
      height: 70px; /* Fotoğraftaki boyuta uygun */
    }
    
    @media (max-width: 768px) { 
      #trendAnglesRow { height: 55px; } 
    }
    
    .trend-angle-box { 
      flex: 1; 
      height: 70px; /* Fotoğraftaki boyuta uygun */
      background: #1a1a1a; 
      border: 2px solid #444; 
      border-radius: 6px; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      transition: background 0.3s, border-color 0.3s; 
      position: relative; 
    }
    
    body.day-mode .trend-angle-box { 
      background: #f5f5f5; 
      border-color: #ccc; 
    }
    
    @media (max-width: 768px) { 
      .trend-angle-box { height: 55px; } 
    }
    
    .trend-angle-canvas { 
      width: 100%; 
      height: 100%; 
    }
    
    /* ... Diğer CSS kodları değişmeden aynı kaldı ... */
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loadingIndicator">
    <div class="spinner"></div>
  </div>
  
  <div id="mainContainer">
    <div id="leftSection">
      <!-- ... Sol bölüm kodları değişmeden aynı ... -->
    </div>
    <div id="rightSection">
      <!-- GÜNCELLENMİŞ: Açı panelleri yan yana -->
      <div id="trendAnglesRow">
        <div class="trend-angle-box">
          <canvas id="trendAngleCanvas1" class="trend-angle-canvas"></canvas>
        </div>
        <div class="trend-angle-box">
          <canvas id="trendAngleCanvas2" class="trend-angle-canvas"></canvas>
        </div>
      </div>
      
      <!-- ... Diğer kodlar değişmeden aynı ... -->
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <script>
    // ========== PERFORMANCE OPTIMIZATIONS ==========
    let lastFrameTime = 0;
    const FRAME_INTERVAL = 16;
    
    const workerMessageQueue = [];
    let workerBusy = false;
    
    // ========== GLOBAL DEĞİŞKENLER ==========
    let audioContext = null;
    let lastTrendSignal = null;
    let currentTrendData = { direction: null, last3: [], colors: [], arrows: [] };
    let trendStartGlobal = null;
    let currentUpDownSignal = null;
    let lastUpDownSignal = null;
    let autoTradeEnabled = false;
    let autoTradeInProgress = false;
    let ws = null;
    let derivWS = null;
    let apiToken = '';
    let isRunning = true;
    let prices = [];
    let digits = [];
    let decimalDigits = [];
    let combinedDigits = [];
    let wormLinesTop = [];
    let numColors = [];
    let currentPair = 'R_100';
    let currentGraph = 'XZ';
    let gridHistory = [];
    let startCooldown = 0;
    let xzTickCounter = 0;
    let startGlobalSpan = null;
    let tradeActive = false;
    let tradeType = '';
    let entrySpot = 0;
    let exitSpot = 0;
    let barrier = 0;
    let tradeData = [];
    let contractId = null;
    let chart = null;
    
    // ========== YENİ TREND AÇI PANELLERİ İÇİN DEĞİŞKENLER ==========
    let trendPanel1Data = { numbers: [], colors: [] };
    let trendPanel2Data = { numbers: [], colors: [] };
    
    // ========== WEB WORKER FOR HEAVY CALCULATIONS ==========
    // ... Web Worker kodu değişmeden aynı ...
    
    // ========== AUDIO FONKSİYONLARI ==========
    // ... Audio fonksiyonları değişmeden aynı ...
    
    // ========== TREND AÇI PANELLERİ FONKSİYONLARI (GÜNCELLENMİŞ) ==========
    function updateTrendPanelsData() {
      if (!startGlobalSpan || gridHistory.length < 4) {
        trendPanel1Data = { numbers: [], colors: [] };
        trendPanel2Data = { numbers: [], colors: [] };
        return;
      }
      
      const vis = gridHistory.length;
      const firstGlobal = xzTickCounter - vis;
      const startFrom = startGlobalSpan.to - firstGlobal + 1;
      
      // Panel 1: İlk kutuyu hemen çiz (veriyi alır almaz)
      const panel1Indices = [];
      if (startFrom - 2 >= 0) panel1Indices.push(startFrom - 2);
      if (startFrom - 1 >= 0) panel1Indices.push(startFrom - 1);
      if (startFrom < vis) panel1Indices.push(startFrom);
      
      trendPanel1Data = {
        numbers: panel1Indices.map(i => gridHistory[i].v),
        colors: panel1Indices.map(i => gridHistory[i].effColor)
      };
      
      // Panel 2: İkinci kutu için daha fazla veri bekliyoruz
      const panel2Indices = [];
      if (startFrom + 1 < vis) panel2Indices.push(startFrom + 1);
      if (startFrom + 2 < vis) panel2Indices.push(startFrom + 2);
      if (startFrom + 3 < vis) panel2Indices.push(startFrom + 3);
      
      trendPanel2Data = {
        numbers: panel2Indices.map(i => gridHistory[i].v),
        colors: panel2Indices.map(i => gridHistory[i].effColor)
      };
    }
    
    function drawTrendPanel(canvasId, panelData) {
      requestAnimationFrame(() => {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        
        const rect = canvas.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        const ctx = canvas.getContext('2d');
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        ctx.clearRect(0, 0, rect.width, rect.height);
        
        const isDark = !document.body.classList.contains('day-mode');
        const width = rect.width;
        const height = rect.height;
        
        if (panelData.numbers.length < 3) return;
        
        const numbers = panelData.numbers;
        const colors = panelData.colors;
        
        // Noktaların pozisyonlarını belirle
        const x1 = width * 0.2;
        const x2 = width * 0.5;
        const x3 = width * 0.8;
        
        // İlk sayı her zaman merkezde
        const y1 = height / 2;
        
        // İkinci sayının pozisyonunu belirle (kurallara göre)
        let y2;
        let vzY = null; // VZ çizgisi pozisyonu
        
        const n1_color = colors[0];
        const n2_color = colors[1];
        const n1_val = numbers[0];
        const n2_val = numbers[1];
        
        // Üst panel çizgisi kuralları (2. sayı üstte)
        if (
          (n1_color === 'red' && n2_color === 'blue') ||
          (n1_color === 'red' && n2_color === 'red' && n2_val < n1_val) ||
          (n1_color === 'blue' && n2_color === 'blue' && n2_val > n1_val)
        ) {
          y2 = height * 0.15; // Üst çizgi
          vzY = y1 - 8; // İlk sayının hemen üstüne VZ çizgisi
        }
        // Alt panel çizgisi kuralları (2. sayı altta)
        else if (
          (n1_color === 'blue' && n2_color === 'red') ||
          (n1_color === 'red' && n2_color === 'red' && n2_val > n1_val) ||
          (n1_color === 'blue' && n2_color === 'blue' && n2_val < n1_val)
        ) {
          y2 = height * 0.85; // Alt çizgi
          vzY = y1 + 8; // İlk sayının hemen altına VZ çizgisi
        } else {
          // Varsayılan: aynı renk ve fark 1'den büyükse
          if (n1_color === n2_color) {
            if (n2_val > n1_val) {
              y2 = height * 0.15;
              vzY = y1 - 8;
            } else {
              y2 = height * 0.85;
              vzY = y1 + 8;
            }
          } else {
            // Farklı renkler için varsayılan
            y2 = height * 0.15;
            vzY = y1 - 8;
          }
        }
        
        // Üçüncü sayının pozisyonunu belirle (YENİ KURALLARA GÖRE - GÜNCELLENDİ)
        let y3;
        const n3_val = numbers[2];
        const n3_color = colors[2];
        
        // 1. KURAL: 3. Sayı üst panel çizgisindeki sayıdan büyükse
        if (y2 === height * 0.15 && n3_val > n2_val) {
          // Üst paneldeki sayıyı aşağı indir, 3. sayıyı en üste koy
          y2 = y2 + 10; // 2. sayıyı biraz aşağı indir
          y3 = height * 0.15; // 3. sayı en üst panele
        }
        // 2. KURAL: 3. Sayı alt panel çizgisindeki sayıdan büyükse
        else if (y2 === height * 0.85 && n3_val > n2_val) {
          // Alt paneldeki sayıyı yukarı kaldır, 3. sayıyı en alta koy
          y2 = y2 - 10; // 2. sayıyı biraz yukarı kaldır
          y3 = height * 0.85; // 3. sayı en alt panele
        }
        // 3. KURAL: 3. Sayı üst panel çizgisinden aşağıda bir sayı ise
        else if (y2 === height * 0.15 && n3_val < n2_val) {
          if (n3_val >= n1_val) {
            // 3. sayı 1. sayıdan küçük değilse
            // 2. sayının altında, 1. sayının üstünde, VZ çizgisinin üstünde
            const midPoint = (y1 + y2) / 2;
            y3 = Math.min(midPoint, vzY - 5); // VZ çizgisinin üstüne
          } else {
            // 3. sayı 1. sayıdan düşük ise
            // Hem 2. sayının hem de 1. sayının altında
            y3 = Math.max(y1 + 15, height * 0.6);
          }
        }
        // 4. KURAL: 3. Sayı alt panel çizgisinden yukarıda bir sayı ise
        else if (y2 === height * 0.85 && n3_val > n2_val) {
          if (n3_val <= n1_val) {
            // 3. sayı 1. sayıdan büyük değilse
            // 2. sayının üstünde, 1. sayının altında, VZ çizgisinin altında
            const midPoint = (y1 + y2) / 2;
            y3 = Math.max(midPoint, vzY + 5); // VZ çizgisinin altına
          } else {
            // 3. sayı 1. sayıdan yukarıda ise
            // Hem 2. sayının hem de 1. sayının üstünde
            y3 = Math.min(y1 - 15, height * 0.4);
          }
        }
        // Varsayılan durum
        else {
          // 3. sayı 1. ve 2. sayıya göre konumlandır
          if (n3_val > n1_val && n3_val > n2_val) {
            y3 = Math.min(y1 - 15, y2 - 15);
            y3 = Math.max(y3, height * 0.1);
          } else if (n3_val < n1_val && n3_val < n2_val) {
            y3 = Math.max(y1 + 15, y2 + 15);
            y3 = Math.min(y3, height * 0.9);
          } else if (n3_val > n1_val && n3_val < n2_val) {
            y3 = y1 - 8;
          } else {
            y3 = y1 + 8;
          }
        }
        
        // Y3 sınırlamaları
        y3 = Math.max(y3, height * 0.1);
        y3 = Math.min(y3, height * 0.9);
        
        // Çizgiyi çiz
        ctx.strokeStyle = isDark ? '#fff' : '#000';
        ctx.lineWidth = 1.5;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.lineTo(x3, y3);
        ctx.stroke();
        
        // GÜNCELLENMİŞ: SADECE 1. VE 2. SAYI ARASINA VZ ÇİZGİSİ
        // Eğer 1. ve 2. sayı arasındaki fark 1 ise
        if (Math.abs(numbers[1] - numbers[0]) === 1 && vzY !== null) {
          ctx.strokeStyle = '#FF9900';
          ctx.lineWidth = 2.0;
          ctx.beginPath();
          ctx.moveTo(x1 - 15, vzY);
          ctx.lineTo(x2 + 15, vzY);
          ctx.stroke();
        }
        // 2. ve 3. sayı arasına VZ çizilmeyecek
        
        // GÜNCELLENMİŞ: Sayı boyutları 11px yapıldı ve çemberler küçültüldü
        const points = [{x: x1, y: y1}, {x: x2, y: y2}, {x: x3, y: y3}];
        points.forEach(function(p, i) {
          // Daire (küçültüldü)
          ctx.fillStyle = isDark ? '#000' : '#fff';
          ctx.beginPath();
          ctx.arc(p.x, p.y, 8, 0, Math.PI * 2); // Yarıçap 8px
          ctx.fill();
          ctx.strokeStyle = isDark ? '#fff' : '#000';
          ctx.lineWidth = 1.5;
          ctx.stroke();
          
          // Sayı (11px)
          ctx.font = 'bold 11px sans-serif'; // Boyut 11px
          ctx.fillStyle = colors[i] === 'blue' ? '#0066ff' : '#cc0000';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(String(numbers[i]), p.x, p.y);
        });
      });
    }
    
    // ========== AUTO TRADE FONKSİYONLARI ==========
    // ... Auto trade fonksiyonları değişmeden aynı ...
    
    // ========== TREND ANALİZ FONKSİYONLARI ==========
    function checkAndSignalTrend() {
      if (currentGraph !== 'XZ' || !startGlobalSpan || !trendStartGlobal || gridHistory.length < 6) {
        showTrendSignal(null);
        updateTrendPanelsData();
        drawTrendPanel('trendAngleCanvas1', trendPanel1Data);
        drawTrendPanel('trendAngleCanvas2', trendPanel2Data);
        return;
      }
      
      workerMessageQueue.push({
        type: 'analyzeTrend',
        data: { gridHistory, startGlobalSpan, xzTickCounter }
      });
      
      if (!workerBusy) {
        processWorkerQueue();
      }
      
      updateTrendPanelsData();
      drawTrendPanel('trendAngleCanvas1', trendPanel1Data);
      drawTrendPanel('trendAngleCanvas2', trendPanel2Data);
    }
    
    function showTrendSignal(direction) {
      const box = document.getElementById('trendBellBox');
      const label = document.getElementById('trendLabel');
      box.classList.remove('trend-up', 'trend-down');
      if (direction === 'UP') {
        box.classList.add('trend-up');
        label.textContent = 'Trend ↑';
        if (lastTrendSignal !== 'UP') {
          playUpTrendSound();
          lastTrendSignal = 'UP';
        }
      } else if (direction === 'DOWN') {
        box.classList.add('trend-down');
        label.textContent = 'Trend ↓';
        if (lastTrendSignal !== 'DOWN') {
          playDownTrendSound();
          lastTrendSignal = 'DOWN';
        }
      } else {
        label.textContent = 'Trend';
        lastTrendSignal = null;
      }
    }
    
    // ========== TEMA FONKSİYONLARI ==========
    // ... Tema fonksiyonları değişmeden aynı ...
    
    // ========== TOKEN FONKSİYONLARI ==========
    // ... Token fonksiyonları değişmeden aynı ...
    
    // ========== KONTROL FONKSİYONLARI ==========
    // ... Kontrol fonksiyonları değişmeden aynı ...
    
    // ========== API FONKSİYONLARI ==========
    // ... API fonksiyonları değişmeden aynı ...
    
    // ========== TRADE CHART ==========
    // ... Trade chart fonksiyonları değişmeden aynı ...
    
    // ========== WORM FONKSİYONLARI ==========
    // ... Worm fonksiyonları değişmeden aynı ...
    
    // ========== XY AREA ==========
    // ... XY area fonksiyonları değişmeden aynı ...
    
    // ========== GRID FONKSİYONLARI ==========
    // ... Grid fonksiyonları değişmeden aynı ...
    
    // ========== WEBSOCKET ==========
    // ... WebSocket fonksiyonları değişmeden aynı ...
    
    // ========== ZAMAN ==========
    // ... Zaman fonksiyonları değişmeden aynı ...
    
    // ========== CHART OLUŞTURMA ==========
    // ... Chart oluşturma fonksiyonları değişmeden aynı ...
    
    // ========== BAŞLATMA ==========
    document.addEventListener('DOMContentLoaded', function() {
      // Hide loading indicator
      setTimeout(() => {
        document.getElementById('loadingIndicator').style.opacity = '0';
        setTimeout(() => {
          document.getElementById('loadingIndicator').style.display = 'none';
        }, 300);
      }, 1000);
      
      // Initialize web worker
      initWebWorker();
      
      // Chart'ı başlat
      initChart();
      
      // Enable hardware acceleration for performance
      document.querySelectorAll('.grid-cell, .num-box, #chartContainer, #xyBox').forEach(el => {
        el.classList.add('performance-mode', 'hw-accelerate');
      });
      
      // Event listener'ları ekle
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
      document.getElementById('graphToggle').addEventListener('click', toggleGraph);
      document.getElementById('startStopBtn').addEventListener('click', toggleStartStop);
      document.getElementById('connectBtn').addEventListener('click', connectAPI);
      document.getElementById('saveCheckbox').addEventListener('change', toggleSaveToken);
      document.getElementById('autoTradeBtn').addEventListener('click', toggleAutoTrade);
      document.getElementById('callBtn').addEventListener('click', function() { placeTrade('CALL'); });
      document.getElementById('putBtn').addEventListener('click', function() { placeTrade('PUT'); });
      
      // Pair butonları
      document.querySelectorAll('.pair-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          selectPair(this.getAttribute('data-pair'));
        });
      });
      
      // Zaman güncelleme
      setInterval(updateTime, 1000);
      updateTime();
      
      // WebSocket başlat
      startWS();
      
      // Token yükle
      loadSavedToken();
      
      // Logoları güncelle
      updateLogos();
      
      // Audio init
      document.body.addEventListener('click', function initAudioOnce() {
        initAudio();
        if (audioContext && audioContext.state === 'suspended') {
          audioContext.resume();
        }
      }, { once: true });
      
      document.body.addEventListener('touchstart', function() {
        if (audioContext && audioContext.state === 'suspended') {
          audioContext.resume();
        }
      }, { passive: true });
      
      // Resize handler with debouncing
      let resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
          renderXYArea();
          renderStartOverlay();
          renderTwoRowGrid();
          drawTrendPanel('trendAngleCanvas1', trendPanel1Data);
          drawTrendPanel('trendAngleCanvas2', trendPanel2Data);
        }, 100);
      });
      
      // Service Worker Registration
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/service-worker.js').then(function(registration) {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, function(err) {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    });
  </script>
</body>
</html>
